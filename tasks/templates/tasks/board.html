{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <p class="text-uppercase text-muted small mb-1">Tasks</p>
      <h1 class="h3 mb-0">Kanban Board</h1>
    </div>
  </div>

  {% include "tasks/partials/board.html" %}
</div>

<script>
    let boardScrollLeft = 0;
    let autoScrollDirection = 0;
    let autoScrollFrame = null;
    let boardEl = null;

    const getBoard = () => {
      boardEl = document.getElementById("kanban-board");
      return boardEl;
    };

    const stopAutoScroll = () => {
      autoScrollDirection = 0;
      if (autoScrollFrame) {
        cancelAnimationFrame(autoScrollFrame);
        autoScrollFrame = null;
      }
    };

    const startAutoScroll = () => {
      if (autoScrollFrame) return;
      const step = () => {
        if (autoScrollDirection !== 0 && boardEl) {
          boardEl.scrollLeft += autoScrollDirection * 18;
          autoScrollFrame = requestAnimationFrame(step);
        } else {
          autoScrollFrame = null;
        }
      };
      autoScrollFrame = requestAnimationFrame(step);
    };

    const initKanbanDragAndDrop = () => {
      const board = getBoard();
      if (!board) return;

      const moveUrl = board.dataset.moveUrl;

      board.querySelectorAll("[data-card]").forEach((card) => {
        card.addEventListener("dragstart", (event) => {
          event.dataTransfer.effectAllowed = "move";
          event.dataTransfer.setData("text/plain", card.dataset.taskId);
          card.classList.add("dragging");
        });
        card.addEventListener("dragend", () => {
          card.classList.remove("dragging");
        });

        card.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            const target = card.dataset.href;
            if (target) window.location.href = target;
          }
        });
      });

      board.querySelectorAll("[data-column]").forEach((column) => {
        column.addEventListener("dragenter", (event) => {
          event.preventDefault();
          column.classList.add("drop-target");
        });
        column.addEventListener("dragover", (event) => {
          event.preventDefault();
        });

        column.addEventListener("drop", (event) => {
          event.preventDefault();
          const taskId = event.dataTransfer.getData("text/plain");
          const status = column.dataset.status;
          column.classList.add("drop-received");
          setTimeout(() => column.classList.remove("drop-received"), 180);
          column.classList.remove("drop-target");
          stopAutoScroll();

          htmx.ajax("POST", moveUrl, {
            target: "#kanban-board",
            swap: "outerHTML",
            values: { task_id: taskId, status },
          });
        });

        column.addEventListener("dragleave", () => {
          column.classList.remove("drop-target");
        });
      });
    };

    document.addEventListener("dragover", (event) => {
      const board = boardEl || getBoard();
      if (!board) return;
      const rect = board.getBoundingClientRect();
      const edgeBuffer = 80;
      const x = event.clientX;
      if (x < rect.left + edgeBuffer) {
        autoScrollDirection = -1;
        startAutoScroll();
      } else if (x > rect.right - edgeBuffer) {
        autoScrollDirection = 1;
        startAutoScroll();
      } else {
        autoScrollDirection = 0;
      }
    });

    document.addEventListener("dragend", () => stopAutoScroll());

    document.addEventListener("htmx:beforeSwap", (event) => {
      if (event.target && event.target.id === "kanban-board") {
        boardScrollLeft = event.target.scrollLeft;
      }
    });

    document.addEventListener("htmx:afterSwap", (event) => {
      if (event.target && event.target.id === "kanban-board") {
        event.target.scrollLeft = boardScrollLeft;
        boardEl = event.target;
        initKanbanDragAndDrop();
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      initKanbanDragAndDrop();
    });
</script>

<style>
  @keyframes popIn {
    0% {
      transform: scale(0.95);
      opacity: 0;
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }
  
  .kanban-card.dragging {
    transition: transform 0.2s ease;
    transform: scale(0.95);
  }

  #kanban-board .kanban-card {
    outline: 2px solid transparent;
    outline-offset: 2px;
    transition: transform 0.2s ease, box-shadow 0.2s ease, outline-color 0.2s ease;
  }

  #kanban-board .kanban-card:focus {
    outline-color: #0d6efd;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.3);
  }

  .kanban-card[data-dropped] {
    animation: popIn 0.2s ease-out;
  }

  #kanban-board .kanban-column {
    width: 350px;
    min-height: 700px;
  }

  @media (max-width: 768px) {
    #kanban-board {
      padding-bottom: 0.5rem;
    }
    #kanban-board .kanban-column {
      width: 85vw;
    }
  }

</style>
{% endblock %}
