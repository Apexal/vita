<div id="kanban-board"
     class="d-flex gap-3 flex-nowrap overflow-auto"
     data-move-url="{% url 'task_move' %}"
     {% if swap_oob %}hx-swap-oob="outerHTML:#kanban-board"{% endif %}>
    {% if error %}
        <div class="col-12">
            <div class="alert alert-danger mb-0">{{ error }}</div>
        </div>
    {% endif %}
    {% for column in columns %}
        <div class="kanban-column flex-shrink-0"
             data-column
             data-status="{{ column.code }}">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-header d-flex justify-content-between align-items-center bg-white">
                    <span class="fw-semibold">{{ column.label }}</span>
                    <span class="badge bg-secondary">{{ column.tasks|length }}</span>
                </div>
                <div class="card-body kanban-column-body">
                    {% for task in column.tasks %}
                        <div class="card mb-2 border-0 shadow-sm position-relative kanban-card bg-light"
                             draggable="true"
                             tabindex="0"
                             data-card
                             data-task-id="{{ task.id }}"
                             data-href="{% url 'edit_task' task.id %}"
                             role="button"
                             aria-label="Edit {{ task.title }}"
                             {% if dropped_task_pk == task.id %}data-dropped{% endif %}>
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-start gap-2">
                                    <div>
                                        <div class="fw-semibold">{{ task.title }}</div>
                                        {% if task.description %}<div class="text-muted small">{{ task.description|truncatechars:100 }}</div>{% endif %}
                                    </div>
                                    <span class="priority-chip priority-{{ task.priority }} d-inline-flex align-items-center gap-1 px-2 py-1 rounded-pill small"
                                          title="Priority: {{ task.get_priority_display }}">
                                        <svg class="priority-icon"
                                             width="14"
                                             height="14"
                                             viewBox="0 0 16 16"
                                             aria-hidden="true"
                                             focusable="false">
                                            {% if task.priority == 1 %}
                                                <circle cx="8" cy="8" r="2"></circle>
                                            {% elif task.priority == 2 %}
                                                <circle cx="5" cy="8" r="2"></circle>
                                                <circle cx="11" cy="8" r="2"></circle>
                                            {% elif task.priority == 3 %}
                                                <circle cx="5" cy="11" r="2"></circle>
                                                <circle cx="8" cy="5" r="2"></circle>
                                                <circle cx="11" cy="11" r="2"></circle>
                                            {% else %}
                                                <path d="M8 1.5 1.5 14h13L8 1.5Z"></path>
                                                <rect x="7.25" y="6.5" width="1.5" height="3.5" rx="0.75"></rect>
                                                <circle cx="8" cy="11.5" r="0.8"></circle>
                                            {% endif %}
                                        </svg>
                                    </span>
                                </div>
                                <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                                    <span class="badge bg-light text-dark border d-inline-flex align-items-center gap-1">
                                        {% if task.energy == "LOW" %}
                                            <span title="Low energy" aria-hidden="true">üôÇ</span>
                                        {% elif task.energy == "MEDIUM" %}
                                            <span title="Medium energy" aria-hidden="true">üòê</span>
                                        {% else %}
                                            <span title="High energy" aria-hidden="true">üò≠</span>
                                        {% endif %}
                                    </span>
                                    {% if task.due_at %}
                                        <span class="badge bg-warning text-dark d-inline-flex align-items-center gap-1">
                                            <svg width="14"
                                                 height="14"
                                                 viewBox="0 0 24 24"
                                                 aria-hidden="true"
                                                 focusable="false">
                                                <path d="M12 6a7 7 0 1 1-7 7 7 7 0 0 1 7-7m0-2a9 9 0 1 0 9 9 9 9 0 0 0-9-9Zm.75 4.5h-1.5v5l4.25 2.55.75-1.23-3.5-2.07Z" fill="currentColor" />
                                            </svg>
                                            Due {{ task.due_at|date:"M j" }}
                                        </span>
                                    {% endif %}
                                    {% if task.estimate_minutes %}
                                        <span class="badge bg-light text-dark border d-inline-flex align-items-center gap-1">
                                            <svg width="12"
                                                 height="12"
                                                 viewBox="0 0 24 24"
                                                 aria-hidden="true"
                                                 focusable="false">
                                                <path d="M12 3a9 9 0 1 0 9 9 9 9 0 0 0-9-9Zm0 2a7 7 0 1 1-7 7 7 7 0 0 1 7-7Z" fill="currentColor" />
                                                <path d="M12.75 7.5h-1.5v5l4 2.4.75-1.22-3.25-1.96Z" fill="currentColor" />
                                            </svg>
                                            {{ task.estimate_minutes }}m
                                        </span>
                                    {% endif %}
                                    {% if task.project %}
                                        <span class="badge bg-light border text-dark d-inline-flex align-items-center gap-1">
                                            <svg width="12"
                                                 height="12"
                                                 viewBox="0 0 16 16"
                                                 aria-hidden="true"
                                                 focusable="false">
                                                <path d="M2 3.5a1.5 1.5 0 0 1 1.5-1.5h9A1.5 1.5 0 0 1 14 3.5V12a1 1 0 0 1-1 1h-2.5L8 15.5 5.5 13H3a1 1 0 0 1-1-1Z" fill="currentColor" />
                                            </svg>
                                            {{ task.project.name }}
                                        </span>
                                    {% endif %}
                                    {% for tag in task.tags.all %}
                                        {% with dot_color=tag.color|default:"#6c757d" %}
                                            <span class="badge bg-light text-dark border d-inline-flex align-items-center gap-1">
                                                <span class="rounded-circle d-inline-block"
                                                      style="width:7px;
                                                             height:7px;
                                                             background:{{ dot_color }}"></span>
                                                {{ tag.name }}
                                            </span>
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                                <a href="{% url 'edit_task' task.id %}"
                                   class="stretched-link"
                                   tabindex="-1"
                                   aria-hidden="true"></a>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-muted small">No tasks yet.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endfor %}
</div>
